<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HBM Luncheon 2025</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Icons (Feather) -->
    <script src="https://unpkg.com/feather-icons"></script>

    <style>
        /* --- ENCHANTED FOREST THEME --- */
        
        /* 1. Import new fonts */
        @import url('https://fonts.googleapis.com/css2?family=EB+Garamond:wght@700&family=Merriweather:wght@400;700&display=swap');
        
        /* 2. Set new body font and background */
        body {
            font-family: 'Merriweather', serif;
            /* Dark green fallback */
            background-color: #0c140f; 
            /* NEW: Stable, permanent Unsplash link for a misty, magical forest */
            background-image: linear-gradient(rgba(0, 0, 0, 0.6), rgba(0, 0, 0, 0.8)), url('https://images.unsplash.com/photo-1511497584788-876760111969?auto=format&fit=crop&w=1920&q=80');
            background-size: cover;
            background-position: center;
            background-attachment: fixed;
            color: #d1d5db; /* Light text */
        }
        
        /* 3. Set new title font */
        .font-magic {
            font-family: 'EB Garamond', serif;
        }

        /* 4. Glassmorphism UI classes for cards/sidebar */
        .sidebar-bg {
            background-color: rgba(17, 24, 39, 0.8); /* bg-gray-900 80% */
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border-right: 1px solid rgba(255, 255, 255, 0.1);
        }
        .card-bg {
            background-color: rgba(31, 41, 55, 0.8); /* bg-gray-800 80% */
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 0.5rem; /* rounded-lg */
        }
        
        /* --- END OF THEME --- */

        /* Page transition */
        .page {
            display: none;
            animation: fadeIn 0.5s;
        }
        .page.active {
            display: block;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        /* Custom scrollbar */
        ::-webkit-scrollbar {
            width: 6px;
        }
        ::-webkit-scrollbar-track {
            background: #1f2937;
        }
        ::-webkit-scrollbar-thumb {
            background: #f59e0b; /* Amber-500 */
            border-radius: 3px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #fcd34d; /* Amber-300 */
        }
        /* Bar graph animation */
        .bar-graph-bar {
            transition: width 0.5s ease-out;
        }

        /* Loading Spinner */
        #loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            /* Use a theme-matching dark green */
            background-color: #0c140f; 
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 10000;
            transition: opacity 0.5s ease-out;
        }
        .spinner {
            width: 56px;
            height: 56px;
            border: 6px solid #f59e0b; /* Amber */
            border-bottom-color: transparent;
            border-radius: 50%;
            display: inline-block;
            box-sizing: border-box;
            animation: rotation 1s linear infinite;
        }
        @keyframes rotation {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Admin Nominee Tabs */
        .admin-nominee-tab {
            cursor: pointer;
            padding: 8px 16px;
            border-bottom: 2px solid transparent;
        }
        .admin-nominee-tab.active {
            color: #f59e0b; /* Amber-500 */
            border-bottom-color: #f59e0b;
        }
        .admin-nominee-panel {
            display: none;
        }
        .admin-nominee-panel.active {
            display: block;
        }
        
        /* Mobile Sidebar */
        @media (max-width: 768px) {
            #sidebar {
                position: fixed;
                left: 0;
                top: 0;
                height: 100%;
                z-index: 40;
                transform: translateX(-100%);
                transition: transform 0.3s ease-in-out;
            }
            #sidebar.open {
                transform: translateX(0);
            }
            #main-content {
                width: 100%;
            }
            #sidebar-overlay {
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background-color: rgba(0, 0, 0, 0.5);
                z-index: 30;
                display: none; /* Hidden by default */
            }
            #sidebar.open + #sidebar-overlay {
                display: block;
            }
        }
        
        /* iFrame embed responsive */
        .embed-container {
            position: relative;
            overflow: hidden;
            width: 100%;
            padding-top: 56.25%; /* 16:9 Aspect Ratio */
            border-radius: 8px;
        }
        .embed-container iframe {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            border: 0;
        }
    </style>
</head>
<body class="flex h-screen overflow-hidden">

    <!-- Loading Overlay -->
    <div id="loading-overlay">
        <div class="spinner"></div>
        <h2 class="text-xl font-magic font-semibold text-white mt-4">HBM Luncheon 2025</h2>
        <p class="text-gray-300 mt-2">Connecting to the enchanted realm...</p>
        <p id="loading-error" class="text-red-400 mt-4 text-center max-w-sm" style="display: none;">
            Error: Could not connect to the database.
        </p>
    </div>

    <!-- Mobile Header -->
    <header class="md:hidden w-full h-16 sidebar-bg flex items-center justify-between px-4 fixed top-0 left-0 z-20" style="border-right: 0; border-bottom: 1px solid rgba(255, 255, 255, 0.1);">
        <button id="menu-toggle-btn" class="text-white">
            <i data-feather="menu" class="w-6 h-6"></i>
        </button>
        <h1 class="text-xl font-magic font-bold text-white tracking-tight">HBM Luncheon 2025</h1>
        <div class="w-6"></div> <!-- Spacer -->
    </header>

    <!-- Sidebar -->
    <aside id="sidebar" class="w-64 sidebar-bg flex-shrink-0 flex flex-col md:relative md:translate-x-0">
        <div class="h-16 md:flex items-center justify-center px-4 hidden">
            <h1 class="text-2xl font-magic font-bold text-white tracking-tight text-center">HBM Luncheon 2025</h1>
        </div>
        <!-- Mobile Header inside sidebar -->
        <div class="md:hidden h-16 flex items-center justify-between px-4 border-b border-gray-700">
             <h1 class="text-xl font-magic font-bold text-white tracking-tight">Menu</h1>
            <button id="menu-close-btn" class="text-white">
                <i data-feather="x" class="w-6 h-6"></i>
            </button>
        </div>
        <nav class="flex-1 overflow-y-auto p-4 space-y-2">
            <!-- Navigation Links -->
            <a href="#programme" class="nav-link flex items-center px-3 py-2 rounded-lg text-gray-300 hover:bg-gray-700 hover:text-white" data-page="programme">
                <i data-feather="calendar" class="w-5 h-5 mr-3"></i>
                Programme
            </a>
            <a href="#tables" class="nav-link flex items-center px-3 py-2 rounded-lg text-gray-300 hover:bg-gray-700 hover:text-white" data-page="tables">
                <i data-feather="map-pin" class="w-5 h-5 mr-3"></i>
                Table Arrangement
            </a>
            <!-- "Helpful Links" Nav Item -->
            <a href="#links" class="nav-link flex items-center px-3 py-2 rounded-lg text-gray-300 hover:bg-gray-700 hover:text-white" data-page="links">
                <i data-feather="link" class="w-5 h-5 mr-3"></i>
                Helpful Links
            </a>
            <a href="#voting" class="nav-link flex items-center px-3 py-2 rounded-lg text-gray-300 hover:bg-gray-700 hover:text-white" data-page="voting">
                <i data-feather="check-square" class="w-5 h-5 mr-3"></i>
                Voting
            </a>
            <a href="#admin" id="nav-admin" class="nav-link flex items-center px-3 py-2 rounded-lg text-gray-300 hover:bg-gray-700 hover:text-white" data-page="admin" style="display: none;">
                <i data-feather="sliders" class="w-5 h-5 mr-3"></i>
                Admin Panel
            </a>
            <a href="#awards" id="nav-awards" class="nav-link flex items-center px-3 py-2 rounded-lg text-gray-300 hover:bg-gray-700 hover:text-white" data-page="awards" style="display: none;">
                <i data-feather="award" class="w-5 h-5 mr-3"></i>
                Awards
            </a>
        </nav>
        <div class="p-4 border-t border-gray-700">
            <a href="#admin-login" id="admin-login-link" class="nav-link flex items-center px-3 py-2 rounded-lg text-gray-400 hover:bg-gray-700 hover:text-white" data-page="admin-login">
                <i data-feather="log-in" class="w-5 h-5 mr-3"></i>
                Admin Login
            </a>
            <a href="#" id="admin-logout-link" class="flex items-center px-3 py-2 rounded-lg text-gray-400 hover:bg-gray-700 hover:text-white" style="display: none;">
                <i data-feather="log-out" class="w-5 h-5 mr-3"></i>
                Logout
            </a>
        </div>
    </aside>

    <!-- Sidebar Overlay for mobile -->
    <div id="sidebar-overlay" class="md:hidden"></div>

    <!-- Main Content -->
    <main id="main-content" class="flex-1 overflow-y-auto pt-16 md:pt-0">
        <div class="p-4 md:p-8" id="app-content">

            <!-- Page: Programme -->
            <div id="page-programme" class="page">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-3xl font-magic font-bold text-white">Event Programme</h2>
                    <button id="add-new-programme-btn" class="card-bg px-4 py-2 rounded-lg text-white font-semibold hover:bg-gray-600" style="display: none;">
                        <i data-feather="plus" class="inline w-4 h-4 mr-1"></i> Add Item
                    </button>
                </div>
                
                <!-- New Embedded Links Section for Programme -->
                <div id="programme-embed-container" class="grid grid-cols-1 gap-6 mb-6">
                    <!-- Embedded programme links (like Canva) will go here -->
                </div>

                <div id="programme-list-container" class="card-bg shadow-xl rounded-lg overflow-hidden">
                    <ul class="divide-y divide-gray-700">
                        <!-- Programme items will be dynamically loaded here -->
                        <li class="p-6 text-gray-400">Loading programme...</li>
                    </ul>
                </div>
            </div>

            <!-- Page: Table Arrangement -->
            <div id="page-tables" class="page">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-3xl font-magic font-bold text-white">Table Arrangement</h2>
                    <button id="add-new-table-btn" class="card-bg px-4 py-2 rounded-lg text-white font-semibold hover:bg-gray-600" style="display: none;">
                        <i data-feather="plus" class="inline w-4 h-4 mr-1"></i> Add New Table
                    </button>
                </div>
                <div id="table-list-container" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                    <!-- Tables will be dynamically loaded here -->
                    <p class="text-gray-400 col-span-full">Loading tables...</p>
                </div>
            </div>

            <!-- Page: Helpful Links (Guest Page) -->
            <div id="page-links" class="page">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-3xl font-magic font-bold text-white">Helpful Links</h2>
                </div>
                
                <!-- New Embedded Links Section for Links Page -->
                <div id="links-embed-container" class="grid grid-cols-1 gap-6 mb-6">
                    <!-- Embedded links (like YouTube) will go here -->
                </div>
                
                <div id="link-list-container" class="card-bg shadow-xl rounded-lg overflow-hidden">
                    <ul class="divide-y divide-gray-700">
                        <!-- Links will be dynamically loaded here -->
                        <li class="p-6 text-gray-400">Loading links...</li>
                    </ul>
                </div>
            </div>

            <!-- Page: Voting -->
            <div id="page-voting" class="page">
                <h2 class="text-3xl font-magic font-bold text-white mb-6">Cast Your Vote</h2>
                <div class="max-w-md mx-auto card-bg shadow-xl rounded-lg p-8">
                    
                    <!-- Vote Submitted Message -->
                    <div id="vote-submitted-msg" class="bg-green-600 text-white p-4 rounded-lg mb-6" style="display: none;">
                        <h4 class="font-bold">Vote Submitted!</h4>
                        <p>Thank you for participating.</p>
                    </div>

                    <!-- Voting Form -->
                    <form id="voting-form">
                        <!-- King of the Night -->
                        <div class="mb-6">
                            <label for="vote-king-select" class="block text-lg font-medium text-amber-400 mb-2">Vote for King</label>
                            <select id="vote-king-select" name="vote-king-select" class="w-full px-4 py-2 bg-gray-700 border border-gray-600 rounded-lg text-white focus:outline-none focus:ring-2 focus:ring-amber-500">
                                <option value="">-- Select Candidate --</option>
                                <!-- Nominees will be populated here -->
                            </select>
                        </div>
                        
                        <!-- Queen of the Night -->
                        <div class="mb-6">
                            <label for="vote-queen-select" class="block text-lg font-medium text-amber-400 mb-2">Vote for Queen</label>
                            <select id="vote-queen-select" name="vote-queen-select" class="w-full px-4 py-2 bg-gray-700 border border-gray-600 rounded-lg text-white focus:outline-none focus:ring-2 focus:ring-amber-500">
                                <option value="">-- Select Candidate --</option>
                                <!-- Nominees will be populated here -->
                            </select>
                        </div>

                        <!-- Best Performance -->
                        <div class="mb-6">
                            <label for="vote-performance-select" class="block text-lg font-medium text-amber-400 mb-2">Vote for Best Performance</label>
                            <select id="vote-performance-select" name="vote-performance-select" class="w-full px-4 py-2 bg-gray-700 border border-gray-600 rounded-lg text-white focus:outline-none focus:ring-2 focus:ring-amber-500">
                                <option value="">-- Select Candidate --</option>
                                <!-- Nominees will be populated here -->
                            </select>
                        </div>
                        
                        <p id="vote-error-msg" class="text-red-400 text-sm mb-4" style="display: none;">Please select a candidate for at least one category.</p>

                        <button type="submit" id="submit-vote-btn" class="w-full bg-amber-600 hover:bg-amber-700 text-white font-bold py-3 px-4 rounded-lg transition duration-300">
                            Submit Vote
                        </button>
                    </form>
                </div>
            </div>

             <!-- Page: Admin Login -->
             <div id="page-admin-login" class="page">
                <h2 class="text-3xl font-magic font-bold text-white mb-6">Admin Login</h2>
                <div class="max-w-sm mx-auto card-bg shadow-xl rounded-lg p-8">
                    <form id="admin-login-form">
                        <div class="mb-6">
                            <label for="admin-password" class="block text-lg font-medium text-gray-300 mb-2">Password</label>
                            <input type="password" id="admin-password" class="w-full px-4 py-2 bg-gray-700 border border-gray-600 rounded-lg text-white focus:outline-none focus:ring-2 focus:ring-amber-500" placeholder="••••••••">
                        </div>
                        <p id="admin-login-error" class="text-red-400 text-sm mb-4" style="display: none;">Incorrect password. Please try again.</p>
                        <button type="submit" id="admin-login-btn" class="w-full bg-amber-600 hover:bg-amber-700 text-white font-bold py-3 px-4 rounded-lg transition duration-300">
                            Login
                        </button>
                    </form>
                </div>
            </div>

            <!-- Page: Admin Panel (Hidden by default) -->
            <div id="page-admin" class="page">
                <h2 class="text-3xl font-magic font-bold text-white mb-6">Admin Panel</h2>
                
                <!-- Admin Sections -->
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                    
                    <!-- Left Column: Controls -->
                    <div class="space-y-8">
                        
                        <!-- Event Status Control -->
                        <div class="card-bg shadow-xl rounded-lg p-6">
                            <h3 class="text-2xl font-magic font-semibold text-white mb-4">Event Status Control</h3>
                            <p class="text-gray-400 mb-4">
                                Current status: <span id="event-status" class="font-bold text-lg text-gray-500">...</span>
                            </p>
                            <p class="text-gray-400 mb-6">Guests only see "Table Arrangement" & "Helpful Links" until you "Go Live".</p>
                            <button id="toggle-event-live-btn" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-4 rounded-lg transition duration-300">
                                Loading...
                            </button>
                        </div>

                        <!-- Table Seating Control -->
                        <div class="card-bg shadow-xl rounded-lg p-6">
                            <h3 class="text-2xl font-magic font-semibold text-white mb-4">Table Seating Control</h3>
                            <p class="text-gray-400 mb-4">
                                Current status: <span id="seating-status" class="font-bold text-lg text-gray-500">...</span>
                            </p>
                            <p class="text-gray-400 mb-6">Stop guests from joining or leaving tables. This allows you to finalize arrangements.</p>
                            <button id="toggle-seating-btn" class="w-full bg-yellow-600 hover:bg-yellow-700 text-white font-bold py-3 px-4 rounded-lg transition duration-300">
                                Loading...
                            </button>
                        </div>

                        <!-- Vote Reset Control -->
                        <div class="card-bg shadow-xl rounded-lg p-6">
                            <h3 class="text-2xl font-magic font-semibold text-white mb-4">Vote Reset Control</h3>
                            <p class="text-gray-400 mb-6">This will permanently delete all votes from all users. Use this to clear test data before the event.</p>
                            <button id="reset-all-votes-btn" class="w-full bg-red-600 hover:bg-red-700 text-white font-bold py-3 px-4 rounded-lg transition duration-300">
                                RESET ALL VOTES
                            </button>
                        </div>

                        <!-- Nominee Management -->
                        <div class="card-bg shadow-xl rounded-lg p-6">
                            <h3 class="text-2xl font-magic font-semibold text-white mb-4">Nominee Management</h3>
                            <p class="text-gray-400 mb-4">Add or remove nominees for voting.</p>
                            
                            <!-- Tabs -->
                            <div class="flex border-b border-gray-700 mb-4">
                                <button class="admin-nominee-tab active" data-tab="king">King</button>
                                <button class="admin-nominee-tab" data-tab="queen">Queen</button>
                                <button class="admin-nominee-tab" data-tab="performance">Performance</button>
                            </div>
                            
                            <!-- Panels -->
                            <div id="admin-nominee-panel-king" class="admin-nominee-panel active space-y-3">
                                <form id="add-nominee-form-king" class="flex gap-2">
                                    <input type="text" id="add-nominee-name-king" class="flex-1 px-3 py-2 bg-gray-700 border border-gray-600 rounded-lg text-white" placeholder="New King Nominee..." required>
                                    <button type="submit" class="bg-amber-600 hover:bg-amber-700 text-white font-bold py-2 px-3 rounded-lg">Add</button>
                                </form>
                                <ul id="nominee-list-king" class="max-h-40 overflow-y-auto space-y-1"></ul>
                                <button id="load-default-nominees-btn" class="w-full mt-4 bg-teal-600 hover:bg-teal-700 text-white font-bold py-2 px-4 rounded-lg">Load Default King & Queen Nominees</button>
                            </div>
                            
                            <div id="admin-nominee-panel-queen" class="admin-nominee-panel space-y-3">
                                <form id="add-nominee-form-queen" class="flex gap-2">
                                    <input type="text" id="add-nominee-name-queen" class="flex-1 px-3 py-2 bg-gray-700 border border-gray-600 rounded-lg text-white" placeholder="New Queen Nominee..." required>
                                    <button type="submit" class="bg-amber-600 hover:bg-amber-700 text-white font-bold py-2 px-3 rounded-lg">Add</button>
                                </form>
                                <ul id="nominee-list-queen" class="max-h-40 overflow-y-auto space-y-1"></ul>
                            </div>
                            
                            <div id="admin-nominee-panel-performance" class="admin-nominee-panel space-y-3">
                                <form id="add-nominee-form-performance" class="flex gap-2">
                                    <input type="text" id="add-nominee-name-performance" class="flex-1 px-3 py-2 bg-gray-700 border border-gray-600 rounded-lg text-white" placeholder="New Performance Nominee..." required>
                                    <button type="submit" class="bg-amber-600 hover:bg-amber-700 text-white font-bold py-2 px-3 rounded-lg">Add</button>
                                </form>
                                <ul id="nominee-list-performance" class="max-h-40 overflow-y-auto space-y-1"></ul>
                            </div>
                        </div>

                        <!-- Updated Helpful Links Management -->
                        <div class="card-bg shadow-xl rounded-lg p-6">
                            <h3 class="text-2xl font-magic font-semibold text-white mb-4">Helpful Links Management</h3>
                            <p class="text-gray-400 mb-4">Manage all links for guests and admins.</p>
                            <form id="add-link-form" class="space-y-3 mb-4">
                                <input type="text" id="add-link-title" class="w-full px-3 py-2 bg-gray-700 border border-gray-600 rounded-lg text-white" placeholder="Link Title (e.g., Map to Venue)" required>
                                <input type="url" id="add-link-url" class="w-full px-3 py-2 bg-gray-700 border border-gray-600 rounded-lg text-white" placeholder="Link URL (https://...)" required>
                                
                                <!-- New Embed URL field -->
                                <input type="url" id="add-link-embed-url" class="w-full px-3 py-2 bg-gray-700 border border-gray-600 rounded-lg text-white" placeholder="Embed URL (Optional, for Canva/YouTube)">
                                
                                <div class="flex items-center">
                                    <input type="checkbox" id="add-link-public" class="h-4 w-4 text-amber-600 bg-gray-700 border-gray-600 rounded">
                                    <label for="add-link-public" class="ml-2 block text-sm text-gray-300">Make this link public</label>
                                </div>
                                
                                <!-- New is_programme_link checkbox -->
                                <div class="flex items-center">
                                    <input type="checkbox" id="add-link-programme" class="h-4 w-4 text-amber-600 bg-gray-700 border-gray-600 rounded">
                                    <label for="add-link-programme" class="ml-2 block text-sm text-gray-300">Show in Programme section</label>
                                </div>
                                
                                <button type="submit" class="w-full bg-amber-600 hover:bg-amber-700 text-white font-bold py-2 px-3 rounded-lg">Add New Link</button>
                            </form>
                            <h4 class="text-lg font-semibold text-white mb-2">All Links</h4>
                            <ul id="admin-link-list" class="max-h-48 overflow-y-auto space-y-2">
                                <!-- Admin link list populated here -->
                            </ul>
                        </div>
                    </div>

                    <!-- Right Column: Live Results -->
                    <div class="card-bg shadow-xl rounded-lg p-6">
                        <h3 class="text-2xl font-magic font-semibold text-white mb-6">Live Vote Results</h3>
                        <p class="text-gray-400 mb-6">This panel updates in real-time as votes are cast.</p>
                        
                        <!-- King Results -->
                        <div class="mb-8">
                            <h4 class="text-lg font-medium text-amber-400 mb-4">King (<span id="total-votes-king">0</span> votes)</h4>
                            <div id="results-king" class="space-y-3">
                                <p class="text-gray-500">No votes yet...</p>
                            </div>
                        </div>
                        
                        <!-- Queen Results -->
                        <div class="mb-8">
                            <h4 class="text-lg font-medium text-amber-400 mb-4">Queen (<span id="total-votes-queen">0</span> votes)</h4>
                            <div id="results-queen" class="space-y-3">
                                <p class="text-gray-500">No votes yet...</p>
                            </div>
                        </div>

                        <!-- Performance Results -->
                        <div>
                            <h4 class="text-lg font-medium text-amber-400 mb-4">Best Performance (<span id="total-votes-performance">0</span> votes)</h4>
                            <div id="results-performance" class="space-y-3">
                                <p class="text-gray-500">No votes yet...</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Page: Awards Announcement (Admin only) -->
            <div id="page-awards" class="page">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-3xl font-magic font-bold text-white">Awards Announcement</h2>
                    <button id="add-new-award-btn" class="card-bg px-4 py-2 rounded-lg text-white font-semibold hover:bg-gray-600" style="display: none;">
                        <i data-feather="plus" class="inline w-4 h-4 mr-1"></i> Add Award
                    </button>
                </div>
                <div id="award-list-container" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                    <!-- Awards will be dynamically loaded here -->
                    <p class="text-gray-400 col-span-full">Loading awards...</p>
                </div>
            </div>

        </div>
    </main>

    <!-- Global Message Popup -->
    <div id="global-message" class="fixed bottom-5 right-5 card-bg border border-amber-500 text-white py-3 px-6 rounded-lg shadow-xl" style="display: none; transform: translateX(200%); transition: transform 0.5s ease-out;">
        <span id="global-message-text">Message!</span>
    </div>


    <!-- Supabase and App Logic -->
    <script type="module">
        // --- Supabase Client (Imported from head) ---
        import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/+esm'

        // --- Supabase Configuration ---
        // *** THESE ARE YOUR PROJECT KEYS ***
        const SUPABASE_URL = 'https://uskgdmfxbgopohefvzdj.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InVza2dkbWZ4YmdvcG9oZWZ2emRqIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjIwODU5NTAsImV4cCI6MjA3NzY2MTk1MH0.R1gJA9AqMgGDqlrcGk9GEMg0XKZT7Z9pZ6hisCdLjSE';
        
        // --- App State ---
        let supabase, userId;
        let realtimeChannel;
        let appReady = false; // Flag to check if app is connected

        // --- Admin Config ---
        const ADMIN_PASSWORD = "admin"; // Password changed
        let isAdmin = false;

        // --- Table Config ---
        const MAX_GUESTS_PER_TABLE = 10;
        
        // --- Global State Variables ---
        // (Moved from previous location to fix initialization error)
        let isSeatingOpen = true; // Default to open, will be updated by listener
        let isEventLive = false; // Default to false, updated by listener
        let lastTableData = [];
        let lastProgrammeData = [];
        let lastAwardData = [];
        let lastNomineeData = [];
        let lastLinksData = []; // For new links


        // --- Default Nominee Lists ---
        const defaultFemaleNominees = [
            "Tan Yee Mun", "GHAYATHRI GOVINDARAJOO", "NG YEE TYING", "Ng Kam Siew", "Nur Aina binti Nordin",
            "Afifah binti Sabjan", "NURZUANA HARAHA", "Farrah Wahida Azizan", "Jasmine Bok", "Ooi Mian Juen",
            "Tan Hwei Yuin", "LEE YOON WEI", "Chew Khai shing", "NUR IMAN FURQANY BINTI FAIZAL RIZAL", "Wong Chia Li",
            "Ooi Lee Hwang", "FARAH NABILA BINTI MOHAMAD SHUKOR", "Nur Qistina binti Sulaiman", "Koh Jia Yee",
            "Nurfariza Aras Agus Salim", "Siti Hajar Rosli", "HAJAR NUR DINI BINTI ZAINI", "Yuhashinee A/P K.Kumaradev",
            "HAZIYAH BINTI ABDUL RAHIM", "Wong Siau Chiau", "LIM SUE CHIE", "Yeoh Su Ming", "Yong Tze Ting",
            "Khaw Shin Yee", "NOR HAZIRAH BINTI BAHANUDIN", "Tiffany Ooi Ching Rou", "Thirusheiila",
            "Noorhidayah binti Mohd Noor", "Teh Jing Wei", "Wong Pey Yuan", "CHANG JING YUN", "Celine choong",
            "NORANIZA BINTI AHMAD", "LIAN MING LEE", "Teoh Juih Yee", "Heng Jia Ling", "AMIRA NURSYAZWANI BINTI MOHAMED ZAKRI",
            "Zarina Bt Ariffin", "NORHAFIZAH BINTI MAT SALAH @ MAT SALEH", "Daeva Sri", "TEOH AI LUAN", "Lee Zhe Yen",
            "Lee Sing Yi", "Heng Yeong Le", "PARIMALAR A/P MURUGIAH", "Yeoh Choon Tien", "Norehan binti Ahmad Saidi",
            "LEE LI CHUEN", "KAMILA HUSNA BINTI AHMAD KAMIL", "Maryam binti omar", "Norsyazwan binti Salim Lim",
            "GAYATHRI A/P JARAHAMAN", "Prevena", "Siti Sarah binti Abd Majid", "Vasugi A/P Kesavan",
            "Nurazrina binti Yuzrin", "SITI SALWA BINTI ISMAIL", "NOR AFWAN ADLINA BINTI BAHARUDDIN", "HAZIANA BINTI HARUN",
            "Nur Fahada Binti Ali", "SURANIZA BINTI SUHAIMI", "Siew Ying Lee", "TEH SZE WEI", "TAN LEE CHIN",
            "TAN EE LINN", "NUR SYAFIQA BINTI ROSLAN", "Ooi Phei Qi"
        ];

        const defaultMaleNominees = [
            "MOHD FAUZI BIN SAAD", "Tan Wei Chong", "FAN SOO KHENG", "TAN LEONG SENG", "Tan Hau Zhe", "NOR HANDY",
            "TAN KUO LIM", "Tan Soo Leon", "YUNESH VEERAPANAIMAN", "HAZIQ BIN AMER", "Izzat Zulkhaireen bin Zakaria",
            "Shunmuga VellanA/L Jayapirakasam", "Amirul Nordin", "Lit Chee Choong", "ROBINSON A/L AJISTAN",
            "Abdul halim bin abdullah", "T PUVANESWARAN AL R THAIKARAJAN", "Muhammad Akmal bin Khalit",
            "MOHD KHAIRIL BIN MOHD ROSSLE", "HAW TONG LIANG", "Ahmad Muizz bin Mohamud Lutfi"
        ];


        // --- App Initialization ---
        document.addEventListener('DOMContentLoaded', async () => {
            try {
                supabase = createClient(SUPABASE_URL, SUPABASE_KEY);
                console.log("Supabase client initialized");

                // Generate a simple, stable user ID and store it
                userId = localStorage.getItem('hbm-user-id');
                if (!userId) {
                    userId = crypto.randomUUID();
                    localStorage.setItem('hbm-user-id', userId);
                }
                console.log("User ID:", userId);

                // Start the app
                await initializeAppLogic();
                appReady = true;

                // Fade out loader
                document.getElementById('loading-overlay').style.opacity = '0';
                setTimeout(() => {
                    document.getElementById('loading-overlay').style.display = 'none';
                }, 500);

            } catch (e) {
                console.error("Supabase initialization error:", e);
                const loadingError = document.getElementById('loading-error');
                // Display the specific error message from the failed load
                loadingError.textContent = `${e.message}`; 
                loadingError.style.display = 'block';
            }
        });


        async function initializeAppLogic() {
            
            // --- Navigation (Define UI elements first!) ---
            // *** MOVED THESE LINES UP TO FIX REFERENCE ERROR ***
            const navLinks = document.querySelectorAll('.nav-link');
            const pages = document.querySelectorAll('.page');
            const nav = document.querySelector('nav');
            const sidebar = document.getElementById('sidebar'); // For mobile close
            const sidebarOverlay = document.getElementById('sidebar-overlay'); // For mobile close
            const menuToggleBtn = document.getElementById('menu-toggle-btn');
            const menuCloseBtn = document.getElementById('menu-close-btn');

            // --- Initial Data Load ---
            // We must load everything once, then start realtime listeners
            try {
                // Settings must be loaded first
                await loadInitialSettings(); 
                
                // Then load everything else
                await Promise.all([
                    loadInitialProgramme(),
                    loadInitialTables(),
                    loadInitialAwards(),
                    loadInitialNominees(),
                    loadUserVotes(),
                    loadInitialLinks() // Load new links
                ]);
            } catch (error) {
                console.error("Failed to load initial data:", error);
                // Re-throw the specific error to be caught by the outer try/catch
                throw new Error(error.message); 
            }


            // --- Start Realtime Listeners ---
            setupRealtimeListeners();

            // --- Navigation ---
            // (Variables defined at the top)

            function showPage(pageId) {
                // Check for admin-only pages
                if ((pageId === 'admin' || pageId === 'awards') && !isAdmin) {
                    pageId = 'admin-login'; // Redirect to login if not admin
                }

                // Check for "Pre-Event" mode
                if (!isAdmin && !isEventLive) {
                    // Guests in pre-event mode can ONLY see tables and links
                    if (pageId !== 'tables' && pageId !== 'links' && pageId !== 'admin-login') {
                        pageId = 'tables'; // Force guests to tables page
                    }
                }

                pages.forEach(page => {
                    page.classList.toggle('active', page.id === `page-${pageId}`);
                });

                navLinks.forEach(link => {
                    link.classList.toggle('bg-gray-700', link.dataset.page === pageId);
                    link.classList.toggle('text-white', link.dataset.page === pageId);
                });

                document.getElementById('admin-login-link').classList.toggle('bg-gray-700', pageId === 'admin-login');
                document.getElementById('admin-login-link').classList.toggle('text-white', pageId === 'admin-login');

                // Re-render things if we are showing that page, to respect admin state
                if (pageId === 'tables') renderTables(lastTableData);
                if (pageId === 'programme') renderProgramme(lastProgrammeData);
                if (pageId === 'awards') renderAwards(lastAwardData);
                if (pageId === 'links') renderLinks(lastLinksData); // Render links page
                if (pageId === 'admin') updateAdminControlUI();
            }

            // --- Mobile Menu Toggle ---
            function closeMobileMenu() {
                sidebar.classList.remove('open');
            }
            menuToggleBtn.addEventListener('click', () => {
                sidebar.classList.add('open');
            });
            menuCloseBtn.addEventListener('click', closeMobileMenu);
            sidebarOverlay.addEventListener('click', closeMobileMenu);

            // *** FIX: Close menu when ANY sidebar link is clicked ***
            sidebar.addEventListener('click', (e) => {
                // Check if the click is on a link or inside a link
                if (e.target.closest('a')) {
                    closeMobileMenu();
                }
            });

            // Handle navigation clicks
            nav.addEventListener('click', (e) => {
                const link = e.target.closest('a.nav-link');
                if (link && link.dataset.page) {
                    e.preventDefault();
                    showPage(link.dataset.page);
                    window.location.hash = link.dataset.page;
                    // closeMobileMenu(); // Handled by sidebar click
                }
            });

            // Handle Admin Login click
            document.getElementById('admin-login-link').addEventListener('click', (e) => {
                e.preventDefault();
                showPage('admin-login');
                window.location.hash = 'admin-login';
                // closeMobileMenu(); // Handled by sidebar click
            });
            
             // Handle Admin Logout click
            document.getElementById('admin-logout-link').addEventListener('click', (e) => {
                e.preventDefault();
                isAdmin = false;
                sessionStorage.removeItem('isAdmin');
                updateAdminUI(); // Update base admin UI
                setPreEventMode(isEventLive); // Re-run pre-event logic to hide links
                showPage(isEventLive ? 'programme' : 'tables'); // Go to default page
                // closeMobileMenu(); // Handled by sidebar click
            });

            // Handle hash changes (e.g., initial load)
            function handleHashChange() {
                let pageId = window.location.hash.substring(1);
                
                if (!pageId) {
                    // If no hash, default to tables (if pre-event) or programme (if live)
                    pageId = isEventLive ? 'programme' : 'tables';
                }
                
                showPage(pageId);
            }
            
            // --- Pre-Event Mode UI ---
            function setPreEventMode(isLive) {
                isEventLive = isLive;
                
                // Show/hide nav links based on event status AND admin status
                document.querySelector('a.nav-link[data-page="programme"]').style.display = (isLive || isAdmin) ? 'flex' : 'none';
                document.querySelector('a.nav-link[data-page="voting"]').style.display = (isLive || isAdmin) ? 'flex' : 'none';
                // document.querySelector('a.nav-link[data-page="awards"]').style.display = (isLive || isAdmin) ? 'flex' : 'none'; // Handled by updateAdminUI
                
                // Table Arrangement and Helpful Links are ALWAYS visible
                document.querySelector('a.nav-link[data-page="tables"]').style.display = 'flex';
                document.querySelector('a.nav-link[data-page="links"]').style.display = 'flex';
                
                // Admin link is only dependent on admin status
                document.getElementById('nav-admin').style.display = isAdmin ? 'flex' : 'none';

                // Re-run hash change to show/hide the correct page
                handleHashChange();
            }


            window.addEventListener('hashchange', handleHashChange);
            // Initial UI setup is now handled by loadInitialSettings
            
            // --- Admin Login/Logout ---
            const adminLoginForm = document.getElementById('admin-login-form');
            adminLoginForm.addEventListener('submit', (e) => {
                e.preventDefault();
                const password = document.getElementById('admin-password').value;
                const errorEl = document.getElementById('admin-login-error');
                
                if (password === ADMIN_PASSWORD) {
                    isAdmin = true;
                    sessionStorage.setItem('isAdmin', 'true');
                    updateAdminUI(); // Update base admin UI
                    setPreEventMode(isEventLive); // Re-run pre-event logic to show all admin links
                    showPage('admin');
                    errorEl.style.display = 'none';
                } else {
                    errorEl.style.display = 'block';
                }
            });
            
            // (Logout listener is now above for menu closing)

            function updateAdminUI() {
                // This function now *only* handles admin-specific controls
                
                // Show/hide admin-specific nav links
                document.getElementById('nav-admin').style.display = isAdmin ? 'flex' : 'none';
                // *** FIX: Show/hide awards link based on admin status ***
                document.getElementById('nav-awards').style.display = isAdmin ? 'flex' : 'none';
                document.getElementById('admin-login-link').style.display = isAdmin ? 'none' : 'flex';
                document.getElementById('admin-logout-link').style.display = isAdmin ? 'flex' : 'none';
                
                // Show/hide admin page controls
                document.getElementById('add-new-table-btn').style.display = isAdmin ? 'inline-block' : 'none';
                document.getElementById('add-new-programme-btn').style.display = isAdmin ? 'inline-block' : 'none';
                document.getElementById('add-new-award-btn').style.display = isAdmin ? 'inline-block' : 'none';
                
                // Update control panel UI (if it exists)
                updateAdminControlUI();
                
                // Force re-render of dynamic pages to show admin/guest views
                renderTables(lastTableData);
                renderProgramme(lastProgrammeData);
                renderAwards(lastAwardData);
                renderLinks(lastLinksData); // Now includes admin links
            }

            // Check session storage on load
            if (sessionStorage.getItem('isAdmin') === 'true') {
                isAdmin = true;
            }
            // updateAdminUI(); // This is called from loadInitialSettings -> setPreEventMode
            
            // --- Admin Control Panel ---
            const toggleSeatingBtn = document.getElementById('toggle-seating-btn');
            const toggleEventLiveBtn = document.getElementById('toggle-event-live-btn');
            const resetAllVotesBtn = document.getElementById('reset-all-votes-btn');

            toggleSeatingBtn.addEventListener('click', async () => {
                const newStatus = !isSeatingOpen; // Toggle the state
                toggleSeatingBtn.disabled = true;

                const { error } = await supabase
                    .from('event_settings')
                    .update({ value: newStatus })
                    .eq('key_name', 'is_seating_open');

                if (error) {
                    console.error("Error updating seating status:", error);
                    showGlobalMessage("Error updating status.", "error");
                } else {
                    showGlobalMessage(`Guest seating is now ${newStatus ? 'OPEN' : 'CLOSED'}!`, "success");
                }
                toggleSeatingBtn.disabled = false;
            });
            
            toggleEventLiveBtn.addEventListener('click', async () => {
                const newStatus = !isEventLive; // Toggle the state
                toggleEventLiveBtn.disabled = true;

                const { error } = await supabase
                    .from('event_settings')
                    .update({ value: newStatus })
                    .eq('key_name', 'is_event_live');

                if (error) {
                    console.error("Error updating event status:", error);
                    showGlobalMessage("Error updating status.", "error");
                } else {
                    showGlobalMessage(`Event is now ${newStatus ? 'LIVE' : 'in PRE-EVENT mode'}!`, "success");
                }
                toggleEventLiveBtn.disabled = false;
            });

            // New listener for resetting votes
            resetAllVotesBtn.addEventListener('click', async () => {
                if (!confirm("ARE YOU SURE?\nThis will permanently delete ALL vote data for King, Queen, and Performance. This cannot be undone.")) {
                    return;
                }
                if (!confirm("SECOND CONFIRMATION: Are you absolutely sure you want to delete all votes?")) {
                    return;
                }

                resetAllVotesBtn.disabled = true;
                resetAllVotesBtn.textContent = "DELETING...";

                try {
                    // *** FIX: Use 'user_id' instead of 'id' to delete ***
                    const { error } = await supabase
                        .from('event_votes')
                        .delete()
                        .neq('user_id', '00000000-0000-0000-0000-000000000000'); // A trick to delete all rows

                    if (error) throw error;
                    
                    showGlobalMessage("All votes have been reset!", "success");
                    // *** FIX: Manually trigger a refresh of the vote results UI ***
                    updateVoteResults();
                } catch (error) {
                    console.error("Error resetting votes:", error);
                    showGlobalMessage(`Vote reset error: ${error.message}`, "error");
                }

                resetAllVotesBtn.disabled = false;
                resetAllVotesBtn.textContent = "RESET ALL VOTES";
            });

            function updateAdminControlUI() {
                if (!isAdmin) return;

                const seatingStatusEl = document.getElementById('seating-status');
                const seatingToggleBtn = document.getElementById('toggle-seating-btn');
                const eventStatusEl = document.getElementById('event-status');
                const eventToggleBtn = document.getElementById('toggle-event-live-btn');
                
                if (!seatingStatusEl || !seatingToggleBtn || !eventStatusEl || !eventToggleBtn) return;

                // Update Seating UI
                if (isSeatingOpen) {
                    seatingStatusEl.textContent = "OPEN";
                    seatingStatusEl.className = "font-bold text-lg text-green-400";
                    seatingToggleBtn.textContent = "Close Guest Seating";
                    seatingToggleBtn.className = "w-full bg-red-600 hover:bg-red-700 text-white font-bold py-3 px-4 rounded-lg transition duration-300";
                } else {
                    seatingStatusEl.textContent = "CLOSED";
                    seatingStatusEl.className = "font-bold text-lg text-red-400";
                    seatingToggleBtn.textContent = "Re-open Guest Seating";
                    seatingToggleBtn.className = "w-full bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-4 rounded-lg transition duration-300";
                }
                
                // Update Event Live UI
                 if (isEventLive) {
                    eventStatusEl.textContent = "LIVE";
                    eventStatusEl.className = "font-bold text-lg text-green-400";
                    eventToggleBtn.textContent = "End Event (Back to Pre-Event Mode)";
                    eventToggleBtn.className = "w-full bg-red-600 hover:bg-red-700 text-white font-bold py-3 px-4 rounded-lg transition duration-300";
                } else {
                    eventStatusEl.textContent = "PRE-EVENT";
                    eventStatusEl.className = "font-bold text-lg text-yellow-400";
                    eventToggleBtn.textContent = "GO LIVE!";
                    eventToggleBtn.className = "w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-4 rounded-lg transition duration-300";
                }
            }


            // --- Voting Logic ---
            const votingForm = document.getElementById('voting-form');
            const submitVoteBtn = document.getElementById('submit-vote-btn');
            const voteSubmittedMsg = document.getElementById('vote-submitted-msg');
            const voteErrorMsg = document.getElementById('vote-error-msg');

            // Load user's current votes into the form
            async function loadUserVotes() {
                if (!userId) return;
                const { data, error } = await supabase
                    .from('event_votes')
                    .select('*')
                    .eq('user_id', userId)
                    .single();

                if (error && error.code !== 'PGRST116') { // Ignore "no rows found"
                     throw new Error(`Failed to load user votes. (${error.message})`);
                }
                
                if (data) {
                    window.userLastVotes = data;
                    // We'll set the values in the nominee load function
                }
            }
            
            votingForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                if (!appReady) {
                    showGlobalMessage("Connecting... Please try again in a moment.", "error");
                    return;
                }
                
                submitVoteBtn.disabled = true;
                submitVoteBtn.textContent = 'Submitting...';
                voteErrorMsg.style.display = 'none';

                const kingVote = document.getElementById('vote-king-select').value || null;
                const queenVote = document.getElementById('vote-queen-select').value || null;
                const performanceVote = document.getElementById('vote-performance-select').value || null;

                if (!kingVote && !queenVote && !performanceVote) {
                    voteErrorMsg.style.display = 'block';
                    submitVoteBtn.disabled = false;
                    submitVoteBtn.textContent = 'Submit Vote';
                    return;
                }

                const newVotes = {
                    user_id: userId,
                    king: kingVote,
                    queen: queenVote,
                    performance: performanceVote
                };

                try {
                    // Supabase 'upsert' will insert or update in one command
                    const { error } = await supabase
                        .from('event_votes')
                        .upsert(newVotes, { onConflict: 'user_id' });

                    if (error) throw error;
                    
                    voteSubmittedMsg.style.display = 'block';
                    window.userLastVotes = newVotes; // Update last votes
                    setTimeout(() => {
                        voteSubmittedMsg.style.display = 'none';
                    }, 3000);

                } catch (error) {
                    console.error("Error submitting vote:", error);
                    showGlobalMessage("Error submitting vote. Please try again.", "error");
                }

                submitVoteBtn.disabled = false;
                submitVoteBtn.textContent = 'Submit Vote';
            });
            
            // --- Nominee Management (Admin) ---
            const adminNomineeTabs = document.querySelectorAll('.admin-nominee-tab');
            const adminNomineePanels = document.querySelectorAll('.admin-nominee-panel');

            adminNomineeTabs.forEach(tab => {
                tab.addEventListener('click', () => {
                    const tabName = tab.dataset.tab;
                    adminNomineeTabs.forEach(t => t.classList.remove('active'));
                    adminNomineePanels.forEach(p => p.classList.remove('active'));
                    tab.classList.add('active');
                    document.getElementById(`admin-nominee-panel-${tabName}`).classList.add('active');
                });
            });

            // Add Nominee Forms
            document.getElementById('add-nominee-form-king').addEventListener('submit', (e) => { e.preventDefault(); addNominee('king'); });
            document.getElementById('add-nominee-form-queen').addEventListener('submit', (e) => { e.preventDefault(); addNominee('queen'); });
            document.getElementById('add-nominee-form-performance').addEventListener('submit', (e) => { e.preventDefault(); addNominee('performance'); });

            async function addNominee(category) {
                const input = document.getElementById(`add-nominee-name-${category}`);
                const name = input.value.trim();
                if (!name) return;

                const { data, error } = await supabase
                    .from('event_nominees')
                    .insert({ category: category, name: name });
                
                if (error) {
                    console.error("Error adding nominee:", error);
                    showGlobalMessage("Error adding nominee.", "error");
                } else {
                    input.value = ''; // Clear input on success
                    showGlobalMessage("Nominee added!", "success");
                }
            }

            // Remove Nominee (event delegation)
            document.getElementById('nominee-list-king').addEventListener('click', (e) => handleNomineeDelete(e));
            document.getElementById('nominee-list-queen').addEventListener('click', (e) => handleNomineeDelete(e));
            document.getElementById('nominee-list-performance').addEventListener('click', (e) => handleNomineeDelete(e));

            async function handleNomineeDelete(e) {
                const deleteBtn = e.target.closest('.delete-nominee-btn');
                if (deleteBtn) {
                    const id = deleteBtn.dataset.id;
                    const name = deleteBtn.dataset.name;
                    if (confirm(`Are you sure you want to remove "${name}"?`)) {
                        const { error } = await supabase
                            .from('event_nominees')
                            .delete()
                            .eq('id', id);
                        
                        if (error) {
                            console.error("Error deleting nominee:", error);
                            showGlobalMessage("Error deleting nominee.", "error");
                        } else {
                            showGlobalMessage("Nominee removed.", "success");
                        }
                    }
                }
            }
            
            // Load Default Nominees
            document.getElementById('load-default-nominees-btn').addEventListener('click', async (e) => {
                if (!confirm("This will add all default male and female participants to the King & Queen nominee lists. Are you sure?")) {
                    return;
                }
                e.target.disabled = true;
                e.target.textContent = "Loading...";

                try {
                    const kingNominees = defaultMaleNominees.map(name => ({ category: 'king', name }));
                    const queenNominees = defaultFemaleNominees.map(name => ({ category: 'queen', name }));

                    const { error: kingError } = await supabase.from('event_nominees').insert(kingNominees, { onConflict: 'category, name' });
                    if (kingError) throw kingError;

                    const { error: queenError } = await supabase.from('event_nominees').insert(queenNominees, { onConflict: 'category, name' });
                    if (queenError) throw queenError;

                    showGlobalMessage("Default nominees loaded!", "success");
                    e.target.style.display = 'none'; // Hide button after success
                } catch (error) {
                    console.error("Error loading default nominees:", error);
                    showGlobalMessage("Error loading nominees. They may already be added.", "error");
                    e.target.disabled = false;
                    e.target.textContent = "Load Default King & Queen Nominees";
                }
            });

            // --- Realtime Listeners ---
            function setupRealtimeListeners() {
                realtimeChannel = supabase
                    .channel('public-changes')
                    .on('postgres_changes', 
                        { event: '*', schema: 'public', table: 'event_programme' }, 
                        (payload) => loadInitialProgramme()
                    )
                    .on('postgres_changes', 
                        { event: '*', schema: 'public', table: 'event_tables' }, 
                        (payload) => loadInitialTables()
                    )
                    .on('postgres_changes', 
                        { event: '*', schema: 'public', table: 'event_awards' }, 
                        (payload) => loadInitialAwards()
                    )
                    .on('postgres_changes', 
                        { event: '*', schema: 'public', table: 'event_links' }, // New listener
                        (payload) => loadInitialLinks()
                    )
                    .on('postgres_changes', 
                        { event: '*', schema: 'public', table: 'event_settings' }, 
                        (payload) => {
                            // Find the changed setting and update it
                            if (payload.new && payload.new.key_name === 'is_seating_open') {
                                isSeatingOpen = payload.new.value;
                                updateAdminControlUI();
                                renderTables(lastTableData); // Re-render tables for guests
                            }
                            if (payload.new && payload.new.key_name === 'is_event_live') {
                                isEventLive = payload.new.value;
                                updateAdminControlUI();
                                setPreEventMode(isEventLive); // Re-render nav for all users
                            }
                        }
                    )
                    .on('postgres_changes', 
                        { event: '*', schema: 'public', table: 'event_nominees' }, 
                        (payload) => loadInitialNominees()
                    )
                    .on('postgres_changes', 
                        { event: '*', schema: 'public', table: 'event_votes' }, 
                        (payload) => updateVoteResults()
                    )
                    .subscribe((status) => {
                        if (status === 'SUBSCRIBED') {
                            console.log('Realtime connected!');
                            // Now that we're connected, let's load the vote results
                            updateVoteResults();
                        }
                    });
            }

            // --- Data Load & Render Functions ---

            // Programme
            async function loadInitialProgramme() {
                const { data, error } = await supabase
                    .from('event_programme')
                    .select('*')
                    .order('id', { ascending: true });
                
                if (error) throw new Error(`Failed to load programme data. (${error.message}). Check RLS policies.`);
                
                lastProgrammeData = data;
                renderProgramme(data);
            }

            function renderProgramme(data) {
                const listContainer = document.getElementById('programme-list-container').querySelector('ul');
                const embedContainer = document.getElementById('programme-embed-container');
                if (!listContainer || !embedContainer) return;
                
                listContainer.innerHTML = '';
                embedContainer.innerHTML = ''; // Clear embed container

                // 1. Render Embedded Links first
                const programmeLinks = lastLinksData.filter(link => link.is_programme_link && link.embed_url);
                programmeLinks.forEach(link => {
                    embedContainer.innerHTML += `
                        <div class="card-bg shadow-xl rounded-lg p-4">
                            <h3 class="text-2xl font-magic font-semibold text-white mb-4">${link.title}</h3>
                            <div class="embed-container">
                                <iframe src="${link.embed_url}" allowfullscreen></iframe>
                            </div>
                        </div>
                    `;
                });

                // 2. Render Text-Based Programme
                if (data.length === 0 && programmeLinks.length === 0) { // Check both
                    listContainer.innerHTML = `<li class="p-6 text-gray-400">${isAdmin ? 'No items added. Click "Add Item" to start.' : 'Programme will be posted here soon.'}</li>`;
                    return;
                }

                data.forEach(item => {
                    const li = document.createElement('li');
                    li.className = "p-6";
                    if (isAdmin) {
                        li.innerHTML = `
                            <div class="flex flex-wrap md:flex-nowrap gap-4">
                                <input type="text" value="${item.time}" data-id="${item.id}" data-field="time" class="programme-edit-input text-lg font-semibold text-amber-400 w-full md:w-32 bg-gray-700 p-1 rounded">
                                <input type="text" value="${item.description}" data-id="${item.id}" data-field="description" class="programme-edit-input text-lg text-gray-300 flex-1 bg-gray-700 p-1 rounded">
                                <div class="flex gap-4">
                                    <button class="programme-save-btn text-green-400 hover:text-green-300" data-id="${item.id}"><i data-feather="save" class="w-5 h-5"></i></button>
                                    <button class="programme-delete-btn text-red-400 hover:text-red-300" data-id="${item.id}"><i data-feather="trash-2" class="w-5 h-5"></i></button>
                                </div>
                            </div>
                        `;
                    } else {
                        li.innerHTML = `
                            <div class="flex items-center">
                                <span class="text-lg font-semibold text-amber-400 w-32">${item.time}</span>
                                <span class="text-lg text-gray-300">${item.description}</span>
                            </div>
                        `;
                    }
                    listContainer.appendChild(li);
                });
                feather.replace();
                attachProgrammeAdminListeners();
            }

            document.getElementById('add-new-programme-btn').addEventListener('click', async () => {
                const { error } = await supabase
                    .from('event_programme')
                    .insert({ time: 'New Time', description: 'New Description' });
                if (error) showGlobalMessage("Error adding item.", "error");
            });

            function attachProgrammeAdminListeners() {
                if (!isAdmin) return;
                
                // Use event delegation on the container
                document.getElementById('programme-list-container').addEventListener('click', async (e) => {
                    const saveBtn = e.target.closest('.programme-save-btn');
                    const deleteBtn = e.target.closest('.programme-delete-btn');

                    if (saveBtn) {
                        const id = saveBtn.dataset.id;
                        const time = document.querySelector(`.programme-edit-input[data-id="${id}"][data-field="time"]`).value;
                        const description = document.querySelector(`.programme-edit-input[data-id="${id}"][data-field="description"]`).value;
                        const { error } = await supabase
                            .from('event_programme')
                            .update({ time, description })
                            .eq('id', id);
                        if (error) showGlobalMessage("Error saving item.", "error");
                        else showGlobalMessage("Programme item saved!", "success");
                    }
                    if (deleteBtn) {
                        const id = deleteBtn.dataset.id;
                        if (confirm("Are you sure you want to delete this item?")) {
                            const { error } = await supabase
                                .from('event_programme')
                                .delete()
                                .eq('id', id);
                            if (error) showGlobalMessage("Error deleting item.", "error");
                        }
                    }
                });
            }

            // Tables
            async function loadInitialTables() {
                const { data, error } = await supabase
                    .from('event_tables')
                    .select('*')
                    .order('table_name', { ascending: true });
                
                if (error) throw new Error(`Failed to load table data. (${error.message}). Check RLS policies.`);
                
                lastTableData = data;
                renderTables(data);
            }

            function renderTables(data) {
                const container = document.getElementById('table-list-container');
                if (!container) return;
                container.innerHTML = '';

                if (data.length === 0) {
                    container.innerHTML = `<p class="text-gray-400 col-span-full">${isAdmin ? 'No tables added yet. Click "Add New Table" to start.' : 'Table arrangements will be posted here soon.'}</p>`;
                    return;
                }

                let userSeat = null;
                data.forEach(table => {
                    const guestList = table.guest_list || [];
                    const found = guestList.find(g => g && g.userId === userId);
                    if (found) {
                        userSeat = { tableId: table.id, tableName: table.table_name };
                    }
                });

                data.forEach(table => {
                    const tableId = table.id;
                    const guestList = table.guest_list || [];
                    const guestCount = guestList.length;

                    let tableHTML = '';
                    if (isAdmin) {
                        const guestListText = guestList.map(g => (typeof g === 'string') ? g : g.name).join('\n');
                        const countColor = guestCount > MAX_GUESTS_PER_TABLE ? 'text-red-400' : 'text-gray-400';
                        const isLocked = table.is_locked || false;
                        
                        tableHTML = `
                        <div class="card-bg shadow-xl rounded-lg p-6 flex flex-col">
                            <input id="table-name-input-${tableId}" class="text-xl font-magic font-semibold text-white mb-4 bg-transparent border-b border-gray-700" value="${table.table_name}">
                            <div class="flex items-center mb-4">
                                <input id="table-lock-check-${tableId}" type="checkbox" class="h-4 w-4 text-amber-600 bg-gray-700 border-gray-600 rounded" ${isLocked ? 'checked' : ''}>
                                <label for="table-lock-check-${tableId}" class="ml-2 block text-sm text-gray-300">Locked (Admin-only list)</label>
                            </div>
                            <div class="flex-1 mb-4">
                                <textarea id="table-textarea-${tableId}" class="w-full h-40 px-3 py-2 bg-gray-700 border border-gray-600 rounded-lg text-white text-sm" placeholder="Enter one guest name per line" style="display: ${isLocked ? 'block' : 'none'};">${guestListText}</textarea>
                                <ul id="table-guest-list-${tableId}" class="space-y-2 text-gray-300 text-sm" style="display: ${isLocked ? 'none' : 'block'}; min-height: 10rem;">
                                    ${guestList.length > 0 ? 
                                        guestList.map(g => `<li>${g.name || g}</li>`).join('') :
                                        '<li class="text-gray-500">Guests can join this table...</li>'
                                    }
                                </ul>
                            </div>
                            <div class="flex justify-between items-center mt-2">
                                <span id="table-countdown-${tableId}" class="text-sm ${countColor} font-medium">${guestCount}/${MAX_GUESTS_PER_TABLE}</span>
                                <div>
                                    <button class="table-delete-btn text-gray-400 hover:text-red-400 mr-3" data-id="${tableId}" data-name="${table.table_name}"><i data-feather="trash-2" class="w-4 h-4"></i></button>
                                    <button class="table-save-btn bg-amber-600 hover:bg-amber-700 text-white text-sm font-bold py-1 px-3 rounded-lg" data-id="${tableId}">Save</button>
                                </div>
                            </div>
                        </div>`;
                    } else {
                        // GUEST View
                        const isLocked = table.is_locked || false;
                        const isFull = guestCount >= MAX_GUESTS_PER_TABLE;
                        const userIsHere = userSeat && userSeat.tableId === tableId;

                        tableHTML = `
                        <div class="card-bg shadow-xl rounded-lg p-6 flex flex-col">
                            <div class="flex justify-between items-center mb-4 border-b border-gray-700 pb-2">
                                <h3 class="text-xl font-magic font-semibold text-white">${table.table_name}</h3>
                                <span class="text-sm font-medium ${isFull ? 'text-red-400' : 'text-gray-400'}">${guestCount}/${MAX_GUESTS_PER_TABLE}</span>
                            </div>
                            <ul class="space-y-2 text-gray-300 flex-1 mb-4" style="min-height: 12rem;">
                                ${guestList.length > 0 ? 
                                    guestList.map(g => `<li class="flex items-center ${g.userId === userId ? 'font-bold text-amber-400' : ''}">
                                        ${g.userId === userId ? '<i data-feather="user-check" class="w-4 h-4 mr-2"></i>' : ''}
                                        ${g.name || g}
                                    </li>`).join('')
                                    : `<li class="text-gray-500 text-sm">${isLocked ? 'No guests assigned.' : 'Be the first to join!'}</li>`
                                }
                            </ul>
                            <div class="mt-2">
                                ${isSeatingOpen ?
                                    (isLocked ? 
                                        '<span class="text-sm text-gray-500">This table is reserved.</span>' :
                                    userIsHere ?
                                        `<button class="table-leave-btn w-full bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-3 rounded-lg" data-id="${tableId}">Leave Table</button>` :
                                    userSeat ?
                                        '<span class="text-sm text-gray-500">You are at another table.</span>' :
                                    isFull ?
                                        '<span class="text-sm text-red-500">This table is full.</span>' :
                                        `<button class="table-join-btn w-full bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-3 rounded-lg" data-id="${tableId}">Join Table</button>`)
                                    :
                                    '<span class="text-sm text-yellow-500">Self-seating is now closed.</span>'
                                }
                            </div>
                        </div>`;
                    }
                    container.innerHTML += tableHTML;
                });
                feather.replace();
                attachTableListeners();
            }

            function attachTableListeners() {
                const container = document.getElementById('table-list-container');
                if (!container) return;

                container.addEventListener('click', (e) => {
                    const saveBtn = e.target.closest('.table-save-btn');
                    const deleteBtn = e.target.closest('.table-delete-btn');
                    const joinBtn = e.target.closest('.table-join-btn');
                    const leaveBtn = e.target.closest('.table-leave-btn');

                    if (isAdmin) {
                        if (saveBtn) saveTableData(saveBtn.dataset.id);
                        if (deleteBtn) deleteTable(deleteBtn.dataset.id, deleteBtn.dataset.name);
                    } else {
                        if (joinBtn) joinTable(joinBtn.dataset.id);
                        if (leaveBtn) leaveTable(leaveBtn.dataset.id);
                    }
                });

                if (isAdmin) {
                    container.querySelectorAll('input[id^="table-lock-check-"]').forEach(check => {
                        check.addEventListener('change', (e) => {
                            const tableId = e.target.id.split('-').pop();
                            const isLocked = e.target.checked;
                            document.getElementById(`table-textarea-${tableId}`).style.display = isLocked ? 'block' : 'none';
                            document.getElementById(`table-guest-list-${tableId}`).style.display = isLocked ? 'none' : 'block';
                            updateTableCountdown(tableId);
                        });
                    });
                    container.querySelectorAll('textarea[id^="table-textarea-"]').forEach(area => {
                        area.addEventListener('input', (e) => {
                            const tableId = e.target.id.split('-').pop();
                            updateTableCountdown(tableId);
                        });
                    });
                }
            }

            function updateTableCountdown(tableId) {
                const textarea = document.getElementById(`table-textarea-${tableId}`);
                const countdownEl = document.getElementById(`table-countdown-${tableId}`);
                if (!textarea || !countdownEl) return;
                
                const guestCount = textarea.value.split('\n').filter(Boolean).length;
                countdownEl.textContent = `${guestCount}/${MAX_GUESTS_PER_TABLE}`;
                
                countdownEl.classList.toggle('text-red-400', guestCount > MAX_GUESTS_PER_TABLE);
                countdownEl.classList.toggle('text-gray-400', guestCount <= MAX_GUESTS_PER_TABLE);
            }

            async function saveTableData(tableId) {
                const saveBtn = document.querySelector(`.table-save-btn[data-id="${tableId}"]`);
                saveBtn.textContent = 'Saving...';

                const table_name = document.getElementById(`table-name-input-${tableId}`).value;
                const is_locked = document.getElementById(`table-lock-check-${tableId}`).checked;
                
                let guest_list = [];
                if (is_locked) {
                    const textarea = document.getElementById(`table-textarea-${tableId}`);
                    guest_list = textarea.value.split('\n').filter(Boolean).map(name => ({ name })); // Save as objects
                } else {
                    const currentTable = lastTableData.find(d => d.id == tableId);
                    if (currentTable) {
                        guest_list = currentTable.guest_list.filter(g => g.userId); // Preserve only joined guests
                    }
                }

                const { error } = await supabase
                    .from('event_tables')
                    .update({ table_name, is_locked, guest_list })
                    .eq('id', tableId);

                if (error) {
                    showGlobalMessage("Error saving table.", "error");
                    console.error("Save error:", error);
                } else {
                    showGlobalMessage(`Saved ${table_name}!`, "success");
                }
                saveBtn.textContent = 'Save';
            }

            async function deleteTable(tableId, tableName) {
                if (confirm(`Are you sure you want to delete "${tableName}"?`)) {
                    const { error } = await supabase
                        .from('event_tables')
                        .delete()
                        .eq('id', tableId);
                    if (error) showGlobalMessage("Error deleting table.", "error");
                }
            }

            document.getElementById('add-new-table-btn').addEventListener('click', async () => {
                const newTableName = `Table ${lastTableData.length + 1}`;
                const { error } = await supabase
                    .from('event_tables')
                    .insert({ table_name: newTableName, is_locked: false, guest_list: [] });
                if (error) showGlobalMessage("Error adding table.", "error");
            });

            async function joinTable(tableId) {
                if (!userId) return;
                
                const guestName = window.prompt("Please enter your name to join this table:");
                if (!guestName || guestName.trim() === "") return;
                
                const newGuest = { userId: userId, name: guestName.trim() };

                // Supabase Edge Function would be better, but for simplicity, we do this on client
                // This is slightly racy, but OK for this use case.
                
                // 1. Check if user is already at a table
                let userIsSeated = false;
                lastTableData.forEach(table => {
                    if (table.guest_list.find(g => g.userId === userId)) {
                        userIsSeated = true;
                    }
                });
                if (userIsSeated) {
                    showGlobalMessage("You are already at another table. Please 'Leave' that table first.", "error");
                    return;
                }

                // 2. Try to join
                const targetTable = lastTableData.find(t => t.id == tableId);
                if (!targetTable) return;
                if (targetTable.guest_list.length >= MAX_GUESTS_PER_TABLE) {
                    showGlobalMessage("This table is now full.", "error");
                    return;
                }

                const newGuestList = [...targetTable.guest_list, newGuest];
                
                const { error } = await supabase
                    .from('event_tables')
                    .update({ guest_list: newGuestList })
                    .eq('id', tableId);
                
                if (error) showGlobalMessage("Error joining table.", "error");
                else showGlobalMessage("You've joined the table!", "success");
            }

            async function leaveTable(tableId) {
                if (!userId) return;

                const targetTable = lastTableData.find(t => t.id == tableId);
                if (!targetTable) return;

                const newGuestList = targetTable.guest_list.filter(g => g.userId !== userId);
                
                const { error } = await supabase
                    .from('event_tables')
                    .update({ guest_list: newGuestList })
                    .eq('id', tableId);
                
                if (error) showGlobalMessage("Error leaving table.", "error");
                else showGlobalMessage("You've left the table.", "success");
            }

            // Awards
            async function loadInitialAwards() {
                const { data, error } = await supabase
                    .from('event_awards')
                    .select('*')
                    .order('id', { ascending: true });
                
                if (error) throw new Error(`Failed to load awards data. (${error.message}). Check RLS policies.`);
                
                lastAwardData = data;
                renderAwards(data);
            }

            function renderAwards(data) {
                const container = document.getElementById('award-list-container');
                if (!container) return;
                container.innerHTML = '';

                if (data.length === 0) {
                    container.innerHTML = `<p class="text-gray-400 col-span-full">No awards added. Click "Add Award" to start.</p>`;
                    return;
                }
                
                data.forEach(award => {
                    const div = document.createElement('div');
                    div.className = "card-bg shadow-xl rounded-lg p-6 text-center";
                    if (isAdmin) {
                        div.innerHTML = `
                            <div class="text-amber-400 mb-4">
                                <i data-feather="award" class="w-16 h-16 mx-auto"></i>
                            </div>
                            <input type="text" value="${award.category}" data-id="${award.id}" data-field="category" class="award-edit-input text-xl font-magic font-semibold text-white mb-2 bg-gray-700 p-1 rounded w-full text-center">
                            <input type="text" value="${award.winner}" data-id="${award.id}" data-field="winner" class="award-edit-input text-2xl font-bold text-amber-400 bg-gray-700 p-1 rounded w-full text-center">
                            <div class="mt-4 flex justify-center gap-4">
                                <button class="award-save-btn text-green-400 hover:text-green-300" data-id="${award.id}"><i data-feather="save" class="w-5 h-5"></i></button>
                                <button class="award-delete-btn text-red-400 hover:text-red-300" data-id="${award.id}"><i data-feather="trash-2" class="w-5 h-5"></i></button>
                            </div>
                        `;
                    } else {
                        // This page is admin-only, but we'll keep this just in case
                        div.innerHTML = `
                            <div class="text-amber-400 mb-4">
                                <i data-feather="award" class="w-16 h-16 mx-auto"></i>
                            </div>
                            <h3 class="text-xl font-magic font-semibold text-white mb-2">${award.category}</h3>
                            <p class="text-2xl font-bold text-amber-400">${award.winner}</p>
                        `;
                    }
                    container.appendChild(div);
                });
                feather.replace();
                attachAwardAdminListeners();
            }

            document.getElementById('add-new-award-btn').addEventListener('click', async () => {
                const { error } = await supabase
                    .from('event_awards')
                    .insert({ category: 'New Category', winner: 'New Winner' });
                if (error) showGlobalMessage("Error adding award.", "error");
            });
            
            function attachAwardAdminListeners() {
                if (!isAdmin) return;
                
                const container = document.getElementById('award-list-container');
                if (!container) return;

                container.addEventListener('click', async (e) => {
                    const saveBtn = e.target.closest('.award-save-btn');
                    const deleteBtn = e.target.closest('.award-delete-btn');

                    if (saveBtn) {
                        const id = saveBtn.dataset.id;
                        const category = document.querySelector(`.award-edit-input[data-id="${id}"][data-field="category"]`).value;
                        const winner = document.querySelector(`.award-edit-input[data-id="${id}"][data-field="winner"]`).value;
                        const { error } = await supabase
                            .from('event_awards')
                            .update({ category, winner })
                            .eq('id', id);
                        if (error) showGlobalMessage("Error saving award.", "error");
                        else showGlobalMessage("Award saved!", "success");
                    }
                    if (deleteBtn) {
                        const id = deleteBtn.dataset.id;
                        if (confirm("Are you sure you want to delete this award?")) {
                            const { error } = await supabase
                                .from('event_awards')
                                .delete()
                                .eq('id', id);
                            if (error) showGlobalMessage("Error deleting award.", "error");
                        }
                    }
                });
            }

            // Settings
            async function loadInitialSettings() {
                const { data, error } = await supabase
                    .from('event_settings')
                    .select('key_name, value');
                
                if (error) throw new Error(`Failed to load settings. (${error.message}). Please check RLS policies.`);

                const settings = {};
                data.forEach(item => {
                    settings[item.key_name] = item.value;
                });

                isSeatingOpen = settings['is_seating_open'] === 'true' || settings['is_seating_open'] === true; // Handle JSONB string/bool
                isEventLive = settings['is_event_live'] === 'true' || settings['is_event_live'] === true;

                // Initial UI setup
                updateAdminUI(); // Run this first to set admin state
                setPreEventMode(isEventLive); // Then set pre-event mode (which respects admin state)
            }

            // Nominees
            async function loadInitialNominees() {
                const { data, error } = await supabase
                    .from('event_nominees')
                    .select('*')
                    .order('name', { ascending: true });
                
                if (error) throw new Error(`Failed to load nominee data. (${error.message}). Check RLS policies.`);
                
                lastNomineeData = data;
                renderNominees(data);
            }

            function renderNominees(data) {
                const kingSelect = document.getElementById('vote-king-select');
                const queenSelect = document.getElementById('vote-queen-select');
                const performanceSelect = document.getElementById('vote-performance-select');
                
                const kingAdminList = document.getElementById('nominee-list-king');
                const queenAdminList = document.getElementById('nominee-list-queen');
                const performanceAdminList = document.getElementById('nominee-list-performance');

                // Clear all
                [kingSelect, queenSelect, performanceSelect].forEach(sel => {
                    if(sel) sel.innerHTML = `<option value="">-- Select Candidate --</option>`;
                });
                [kingAdminList, queenAdminList, performanceAdminList].forEach(list => {
                    if(list) list.innerHTML = '';
                });

                data.forEach(nominee => {
                    const option = document.createElement('option');
                    option.value = nominee.name;
                    option.textContent = nominee.name;

                    const adminLi = document.createElement('li');
                    adminLi.className = "flex justify-between items-center bg-gray-700 px-3 py-1 rounded";
                    adminLi.innerHTML = `
                        <span class="text-gray-300">${nominee.name}</span>
                        <button class="delete-nominee-btn text-red-500 hover:text-red-400" data-id="${nominee.id}" data-name="${nominee.name}">
                            <i data-feather="x-circle" class="w-4 h-4"></i>
                        </button>
                    `;
                    
                    if (nominee.category === 'king') {
                        if (kingSelect) kingSelect.appendChild(option);
                        if (kingAdminList) kingAdminList.appendChild(adminLi);
                    } else if (nominee.category === 'queen') {
                        if (queenSelect) queenSelect.appendChild(option);
                        if (queenAdminList) queenAdminList.appendChild(adminLi);
                    } else if (nominee.category === 'performance') {
                        if (performanceSelect) performanceSelect.appendChild(option);
                        if (performanceAdminList) performanceAdminList.appendChild(adminLi);
                    }
                });

                // Reselect user's last vote if it exists
                if (window.userLastVotes) {
                    if (kingSelect && window.userLastVotes.king) kingSelect.value = window.userLastVotes.king;
                    if (queenSelect && window.userLastVotes.queen) queenSelect.value = window.userLastVotes.queen;
                    if (performanceSelect && window.userLastVotes.performance) performanceSelect.value = window.userLastVotes.performance;
                }
                
                feather.replace();
            }
            
            // Vote Results
            async function updateVoteResults() {
                const { data: votes, error } = await supabase
                    .from('event_votes')
                    .select('king, queen, performance');
                
                if (error) {
                    console.error("Error fetching vote results:", error);
                    return;
                }

                const kingCounts = {};
                const queenCounts = {};
                const performanceCounts = {};
                
                let totalKing = 0;
                let totalQueen = 0;
                let totalPerformance = 0;

                votes.forEach(vote => {
                    if (vote.king) {
                        kingCounts[vote.king] = (kingCounts[vote.king] || 0) + 1;
                        totalKing++;
                    }
                    if (vote.queen) {
                        queenCounts[vote.queen] = (queenCounts[vote.queen] || 0) + 1;
                        totalQueen++;
                    }
                    if (vote.performance) {
                        performanceCounts[vote.performance] = (performanceCounts[vote.performance] || 0) + 1;
                        totalPerformance++;
                    }
                });

                renderResultsUI(kingCounts, totalKing, 'king');
                renderResultsUI(queenCounts, totalQueen, 'queen');
                renderResultsUI(performanceCounts, totalPerformance, 'performance');
            }

            function renderResultsUI(counts, totalVotes, category) {
                const resultsContainer = document.getElementById(`results-${category}`);
                const totalVotesEl = document.getElementById(`total-votes-${category}`);
                if (!resultsContainer || !totalVotesEl) return;

                totalVotesEl.textContent = totalVotes;
                
                if (totalVotes === 0) {
                    resultsContainer.innerHTML = '<p class="text-gray-500">No votes yet...</p>';
                    return;
                }

                const sortedNominees = Object.entries(counts)
                    .sort(([, votesA], [, votesB]) => votesB - votesA)
                    .slice(0, 10); // Show top 10

                let bgClass = 'bg-amber-500'; // Theme color

                resultsContainer.innerHTML = sortedNominees.map(([name, votes]) => {
                    const percentage = totalVotes > 0 ? (votes / totalVotes) * 100 : 0;
                    return `
                        <div class="bar-graph-item">
                            <div class="flex justify-between items-center mb-1">
                                <span class="text-gray-300 font-medium">${name}</span>
                                <span class="text-gray-400 text-sm">${votes} votes</span>
                            </div>
                            <div class="w-full bg-gray-700 rounded-full h-2.5">
                                <div class="${bgClass} h-2.5 rounded-full bar-graph-bar" style="width: ${percentage}%"></div>
                            </div>
                        </div>
                    `;
                }).join('');
            }

            // --- New Links Functions ---
            async function loadInitialLinks() {
                const { data, error } = await supabase
                    .from('event_links')
                    .select('*')
                    .order('created_at', { ascending: true });
                
                if (error) throw new Error(`Failed to load links data. (${error.message}). Check RLS policies.`);
                
                lastLinksData = data;
                renderLinks(data); // Renders for guests
                if (isAdmin) renderAdminLinks(data); // Renders for admin
                
                // Also re-render programme in case a link was added/removed
                renderProgramme(lastProgrammeData);
            }

            function renderLinks(data) {
                const listContainer = document.getElementById('link-list-container').querySelector('ul');
                const embedContainer = document.getElementById('links-embed-container');
                if (!listContainer || !embedContainer) return;
                
                // Guests ONLY see public links
                const publicLinks = data.filter(link => link.is_public);
                
                listContainer.innerHTML = '';
                embedContainer.innerHTML = '';
                
                let regularLinksExist = false;
                
                publicLinks.forEach(link => {
                    // Check if it's an embed for this page
                    if (link.embed_url && !link.is_programme_link) {
                        embedContainer.innerHTML += `
                            <div class="card-bg shadow-xl rounded-lg p-4">
                                <h3 class="text-2xl font-magic font-semibold text-white mb-4">${link.title}</h3>
                                <div class="embed-container">
                                    <iframe src="${link.embed_url}" allowfullscreen></iframe>
                                </div>
                            </div>
                        `;
                    }
                    // If it's not an embed, show as a regular link
                    else if (!link.embed_url) {
                        regularLinksExist = true;
                        const li = document.createElement('li');
                        li.className = "p-6";
                        li.innerHTML = `
                            <a href="${link.url}" target="_blank" rel="noopener noreferrer" class="flex items-center justify-between text-gray-300 hover:text-amber-400 group">
                                <span class="text-lg font-semibold">${link.title}</span>
                                <i data-feather="external-link" class="w-5 h-5 text-gray-500 group-hover:text-amber-400"></i>
                            </a>
                        `;
                        listContainer.appendChild(li);
                    }
                });

                // Handle no links
                if (publicLinks.length === 0) {
                    listContainer.innerHTML = `<li class="p-6 text-gray-400">No links have been added yet.</li>`;
                } else if (!regularLinksExist) {
                     listContainer.innerHTML = `<li class="p-6 text-gray-400">All public links are shown as embedded content above.</li>`;
                }

                feather.replace();
            }

            function renderAdminLinks(data) {
                if (!isAdmin) return;
                const container = document.getElementById('admin-link-list');
                if (!container) return;
                container.innerHTML = '';

                // Admins see ALL links
                if (data.length === 0) {
                    container.innerHTML = `<li class="p-2 text-gray-500 text-sm">No links added yet.</li>`;
                    return;
                }

                data.forEach(link => {
                    const li = document.createElement('li');
                    li.className = "flex justify-between items-center bg-gray-700 px-3 py-2 rounded";
                    
                    // *** FIX: Changed <span> to <a> for the delete button to make the icon render ***
                    li.innerHTML = `
                        <span class="flex items-center gap-2 overflow-hidden">
                            <i data-feather="${link.is_public ? 'eye' : 'eye-off'}" class="w-4 h-4 ${link.is_public ? 'text-green-400' : 'text-gray-500'} flex-shrink-0" title="${link.is_public ? 'Public Link' : 'Admin-Only Link'}"></i>
                            <i data-feather="${link.is_programme_link ? 'calendar' : 'link'}" class="w-4 h-4 ${link.is_programme_link ? 'text-blue-400' : 'text-gray-500'} flex-shrink-0" title="${link.is_programme_link ? 'Shows in Programme' : 'Regular Link'}"></i>
                            <a href="${link.url}" target="_blank" class="text-gray-300 truncate hover:text-amber-300" title="${link.title}">${link.title}</a>
                        </span>
                        <a href="#" class="delete-link-btn text-red-500 hover:text-red-400" data-id="${link.id}" data-title="${link.title}">
                            <i data-feather="x-circle" class="w-4 h-4"></i>
                        </a>
                    `;
                    container.appendChild(li);
                });
                feather.replace();
            }

            document.getElementById('add-link-form').addEventListener('submit', async (e) => {
                e.preventDefault();
                const titleInput = document.getElementById('add-link-title');
                const urlInput = document.getElementById('add-link-url');
                const embedUrlInput = document.getElementById('add-link-embed-url');
                const publicCheckbox = document.getElementById('add-link-public');
                const programmeCheckbox = document.getElementById('add-link-programme');
                
                const title = titleInput.value.trim();
                const url = urlInput.value.trim();
                const embed_url = embedUrlInput.value.trim() || null; // Save as null if empty
                const is_public = publicCheckbox.checked;
                const is_programme_link = programmeCheckbox.checked;

                if (!title || !url) return;

                const { error } = await supabase
                    .from('event_links')
                    .insert({ title, url, embed_url, is_public, is_programme_link }); 

                if (error) {
                    showGlobalMessage("Error adding link.", "error");
                    console.error("Error adding link:", error);
                } else {
                    showGlobalMessage("Link added!", "success");
                    titleInput.value = '';
                    urlInput.value = '';
                    embedUrlInput.value = '';
                    publicCheckbox.checked = false;
                    programmeCheckbox.checked = false;
                }
            });

            document.getElementById('admin-link-list').addEventListener('click', async (e) => {
                e.preventDefault(); // Prevent <a> tag from navigating
                const deleteBtn = e.target.closest('.delete-link-btn');
                if (deleteBtn && isAdmin) {
                    const id = deleteBtn.dataset.id;
                    const title = deleteBtn.dataset.title;
                    if (confirm(`Are you sure you want to delete the link "${title}"?`)) {
                        const { error } = await supabase
                            .from('event_links')
                            .delete()
                            .eq('id', id);
                        
                        if (error) showGlobalMessage("Error deleting link.", "error");
                        else showGlobalMessage("Link deleted.", "success");
                    }
                }
            });


            // --- Global UI ---
            feather.replace(); // Initialize icons

            function showGlobalMessage(message, type = "success") {
                const el = document.getElementById('global-message');
                const textEl = document.getElementById('global-message-text');

                textEl.textContent = message;
                
                el.classList.remove('bg-green-600', 'bg-red-600', 'card-bg', 'border-amber-500');
                if (type === 'success') {
                    el.classList.add('bg-green-600');
                    textEl.classList.add('text-white');
                } else if (type === 'error') {
                    el.classList.add('bg-red-600');
                    textEl.classList.add('text-white');
                } else {
                    el.classList.add('card-bg', 'border-amber-500');
                    textEl.classList.add('text-white');
                }

                el.style.display = 'block';
                el.style.transform = 'translateX(0)';

                setTimeout(() => {
                    el.style.transform = 'translateX(200%)';
                }, 3000);

                setTimeout(() => {
                    el.style.display = 'none';
                }, 3500);
            }

        } // End of initializeAppLogic
    </script>

</body>
</html>